<style>
#leaguecontent a {
 color: blue
}
</style>
<div id=leaguecontent>

{% if must_signin %}
   Please <a href="{% url 'accounts:login' %}">sign in</a> first
{% elif must_have_league %}


   {% if league_join %}
      Do you want to join {{ league_join.name }}? <a href="#" onclick="return post_fa(this)" data_page="ask_join" data_post="{{league_join.id}}">Yes, ask to join</a>
   {% else %}
   You are not member of a league right now.
   You can join a league or create one.
   {% endif %}


  {% if available_leagues %}
     <hr />
     Leagues available to join:
     <ul>
     {% for league in available_leagues %}
       <li>{{ league.name }}
       {% if league.asked %}
         <strong>Asked to join</strong> (waiting for moderator approval)
       {% else %}
         <a href="#" onclick="return post_fa(this)" data_page="ask_join" data_post="{{league.id}}">ask to join</a>
       {% endif %}
       </li>
     {% endfor %}
     </ul>
  {% endif %}
  <hr />
  Create new league:
  <form href="#" onsubmit="return post_ff(this)" data_page="create">
      Name: <input type="text" class="data_holder" name="name" /><input type="submit" value="create" /><strong class="result_holder"></strong>
  </form>


{% else %}
   <div style="text-align: center; margin-bottom: 10px; font-size: 20px">
     League <strong>{{league.name}}</strong>
   </div>

   Members:

   <ul>
   {% for user in users %}
     <li>
     Name: {{ user.first_name }} {{ user.last_name }}
     <br />
     Points: {{user.points}}
     <br />
     {% if user.admin %}
       Is admin
       <br />
     {% elif user.moderator %}
       Is moderator
       {% if league_user.admin %}
         | <a href="#" onclick="return post_fa(this)" data_page="remove_moderator" data_post="{{user.user_id}}">Remove moderator tools</a>
       {% endif %}
       <br />
     {% elif league_user.admin %}
       <a href="#" onclick="return post_fa(this)" data_page="add_moderator" data_post="{{user.user_id}}">Set as moderator</a>
       <br />
     {% endif %}

     {% if league_user.admin and not user.admin %}
       <a href="#" onclick="return post_fa(this)" data_page="transfer_admin" data_post="{{user.user_id}}" class="admin_transfer">Transfer admin powers to this user<br /></a>
     {% endif %}

     {% if not user.admin and not user.moderator and league_user.moderator or league_user.admin %}
       {% if user.user_id != league_user.user_id %}
         <a href="#" onclick="return post_fa(this)" data_page="remove_user" data_post="{{user.user_id}}">Remove from league</a>
         <br />
       {% endif %}
     {% endif %}
     </li>
   {% endfor %}
   </ul>


   <hr />
   <br />
   <ul>
   {% if league_user.moderator and not league_user.admin %}
      <li><a href="#" onclick="return post_fa(this)" data_page="remove_moderator" data_post="{{league_user.user_id}}">Abdicate moderating powers</a></li>
   {% endif %}

   {% if league_user.admin %}
      <style>
        .admin_transfer {
           display: none;
           font-weight: bold;
        }
      </style>
      <script>
        var transfer_admin = function() {
            $(".admin_transfer").css('display', 'inline');
            $("#admin_transf").css("font-weight", "bold");
            $("#admin_transf").css("color", "red");
            $("#admin_transf").html("Attention: you will no longer be the admin of this group. This action is not reversible");
        }
      </script>

      <li><span id="admin_transf"><a href="#" onclick="return transfer_admin()">Transfer league admin powers</a></span></li>
   {% endif %}

   <li><a href="#" onclick="return post_fa(this)" data_page="leave" data_post="pass">Leave league</a></li>
   </ul>


   {% if league_user.moderator or league_user.admin %}
   <br />
   <hr />
   <br />
   Users who asked to join the league:
   <ul>
     {% if users_invited %}
       {% for user in users_invited %}
          <li>User {{ user.user.first_name }} {{ user.user.last_name }} <a href="#" onclick="return post_fa(this)" data_page="add_user" data_post="{{ user.user.id }}">add user</a></li>
       {% endfor %}
     {% else %}
     <li>No user pending acceptance.</li>
     {% endif %}
     <!-- <li>Share the league URL to invite new users:
     </li> -->
   </ul>
   {% endif %}


{% endif %}
<link rel="stylesheet" href="/static/jquery-ui-1.12.1/jquery-ui.css">
<script src="/static/jquery-1.12.4.js"></script>
<script src="/static/jquery-ui-1.12.1/jquery-ui.js"></script>

<span id="crfs_token" style="display: none">
  {% csrf_token %}
</span>
<script>
function post_ff(elem_main) {
  var elem_main = $(elem_main);
  var elem_data = elem_main.children(".data_holder");
  var elem_result = elem_main.children(".result_holder");

  var page = elem_main.attr('data_page');
  var post = elem_data.val();

  return post_ready(elem_result, page, post);
}
function post_fa(elem_main) {
  var elem_main = $(elem_main);
  var page = elem_main.attr('data_page');
  var post = elem_main.attr('data_post');
  var confirmed = elem_main.attr('confirmed');

  if (confirmed) {
      var elem_result = elem_main.parent().wrap("<span></span>").parent();
      return post_ready(elem_result, page, post);
  }
  else {
      elem_main = elem_main.wrap("<span></span>");
      elem_main.attr("confirmed", 1);
      elem_main.html("Yes, confirm!");
      elem_main.parent().html("<strong>Are you sure of this? |</strong> " +
        ' <a href="#" onclick="return post_fa_cancel(this)">No, cancel!</a> <strong>|</strong> ' +
        elem_main.parent().html());
      return false;
  }
}
function post_fa_cancel(elem) {
  $(elem).parent().html("<strong>Canceled</strong>");
  return false;
}
function post_ready(elem, page, post) {
  elem.wrap("<strong></strong>");
  elem.html("Processing");
  $.ajax({
    type: "POST",
    url: "{% url 'games:league' %}" + page,
    data: "data=" + encodeURIComponent(post) +
          "&csrfmiddlewaretoken=" +
          $("[name=csrfmiddlewaretoken]").val(),
    success: function(res){},
    dataType: "html",
  })
  .done(function(res) {
    elem.html("<span style='color: green'>Sucess</span>");
  })
  .fail(function(res) {
    rt = res.responseText
    switch (rt) {
    case "name_taken":
        text = "this name has already been taken";
        break;
    case "invalid_league_name":
        text = "invalid name. Must only cointain letters, numbers and spaces";
        break;
    case "league_full":
        text = "league is full";
        break;
    case "user_already_has_league":
        text = "the user already has a league";
        break;
    case "cannot_remove_adm_nor_mod":
        text = "only the admin can remove moderators";
        break;
    case "not_admin_nor_mod":
        text = "you are not the admin nor a moderator";
        break;
    case "not_admin":
        text = "you are not the admin";
        break;
    case "must_use_post":
        text = "you must use http POST";
        break;
    case "must_empty_or_transfer_group":
        text = "you must remove everyone or transfer admin powers before leaving";
        break;
    case "cannot_autoremove":
        text = "you cannot remove yourself, use leave instead";
        break;
    case "user_did_not_asked_to_join":
        text = "this user did not asked to join league";
        break;
    default:
        text = "unknown error";
        if (rt.length <= 50) {
          text = " " + rt;
        }
    }
    elem.html("<span style='color: red'>Failure: " + text + "</span>");
  })
  return false;
}
</script>

</div>
